q_incr2 <- total_QALYs["with_drug_care"] - total_QALYs["with_drug"]
# Incremental cost-effectiveness ratio
ICER1 <- c_incr1/q_incr1
ICER2 <- c_incr2/q_incr2
ICER1
ICER2
if(!'ggplot2' %in% installed.packages()){install.packages('ggplot2')}
library(ggplot2)
# To use ggplot, create a dataframe that have both outcomes in one table
dt_ICER <- data.frame(strategy = t_names,
q_incr = c(0,q_incr1,q_incr2),
c_incr = c(0,c_incr1,c_incr2))
wtp <- 20000
ggplot(dt_ICER,aes(x=q_incr,y=c_incr,label=strategy))+
geom_point()+
geom_abline(aes(intercept=0,slope=wtp))+
geom_text(hjust=0.5,vjust=1)+
xlab("QALY difference")+
ylab("Cost difference")+
theme_bw()
cycle_state_cost
v1 <- c(1,2,3)
m1 <- matrix(seq(1,9),nrow=3)
v1
m1
v1 *m1
knitr::opts_chunk$set(echo = TRUE)
t_names <- c("without_drug", "with_drug")#t_names : strategy/scenario label
n_treatments <- length(t_names)#n_treatment: number of strategies
s_names  <- c("Asymptomatic_disease", "Progressive_disease", "Dead")#s_names: vector of health states
n_states <- length(s_names)#n_states: number of health states
n_cohort <- 1000#n_cohort: cohort size
cycle <- 1#cycle: cycle length
n_cycles <- 46#n_cylces: total number of cycles
Initial_age <- 55#Initial_age: age at the beginning of simulation
cAsymp <- 500#cAsymp: cost of having asymptomatic disease (per-cycle cost)
cDeath <- 1000#cDeath: cost of death (transitional cost), only applies to the death among progressive dx
cDrug <- 1000#cDrug: cost of drug
cProg <- 3000#cProg: cost of having progressive disease (per-cycle cost)
uAsymp <- 0.95#uAsymp: utility of having asymptomatic disease
uProg <- 0.75#uProg: utility of having progressive disease
oDr <- 0.06#oDr: discount rate for qaly
cDr <- 0.06#cDr: discount rate for cost
tpDcm <- 0.15#tpDcm: excess mortality with progressive disease
tpProg <- 0.01#tpProg: transition probability from asymptomatic to progressive disease
tpDn <- 0.0379  #pDn: baseline mortality <- mortality 0.0379  # over 65 year old
effect <- 0.5#effect: drug efficacy in decreasing the risk of progressing from asymptomatic to progressive disease
# cost of staying in state
state_c_matrix <-
matrix(c(cAsymp, cProg, 0,
cAsymp + cDrug, cProg, 0),
byrow = TRUE,
nrow = n_treatments,
dimnames = list(t_names,
s_names))
state_c_matrix
# qaly when staying in state
state_q_matrix <-
matrix(c(uAsymp, uProg, 0,
uAsymp, uProg, 0),
byrow = TRUE,
nrow = n_treatments,
dimnames = list(t_names,
s_names))
state_q_matrix
# cost of moving to a state
# same for both treatments
trans_c_matrix <-
matrix(c(0, 0, 0,
0, 0, cDeath,
0, 0, 0),
byrow = TRUE,
nrow = n_states,
dimnames = list(from = s_names,
to = s_names))
trans_c_matrix
state_c_matrix
# qaly when staying in state
state_q_matrix <-
matrix(c(uAsymp, uProg, 0,
uAsymp, uProg, 0),
byrow = TRUE,
nrow = n_treatments,
dimnames = list(t_names,
s_names))
state_q_matrix
# cost of moving to a state
# same for both treatments
trans_c_matrix <-
matrix(c(0, 0, 0,
0, 0, cDeath,
0, 0, 0),
byrow = TRUE,
nrow = n_states,
dimnames = list(from = s_names,
to = s_names))
trans_c_matrix
# time-homogeneous
p_matrix <- array(data = c(1 - tpProg - tpDn, 0, 0,
tpProg, 1 - tpDcm - tpDn, 0,
tpDn, tpDcm + tpDn, 1,
1 - tpProg*(1-effect) - tpDn, 0, 0,
tpProg*(1-effect), 1 - tpDcm - tpDn, 0,
tpDn, tpDcm + tpDn, 1),
dim = c(n_states, n_states, n_treatments),
dimnames = list(from = s_names,
to = s_names,
t_names))
p_matrix
# Transition probabilities ----
# time-homogeneous
p_matrix <- array(data = c(1 - tpProg - tpDn, 0, 0,
tpProg, 1 - tpDcm - tpDn, 0,
tpDn, tpDcm + tpDn, 1,
1 - tpProg*(1-effect) - tpDn, 0, 0,
tpProg*(1-effect), 1 - tpDcm - tpDn, 0,
tpDn, tpDcm + tpDn, 1),
dim = c(n_states, n_states, n_treatments),
dimnames = list(from = s_names,
to = s_names,
t_names))
p_matrix
# state populations
pop <- array(data = NA,
dim = c(n_states, n_cycles, n_treatments),
dimnames = list(state = s_names,
cycle = NULL,
treatment = t_names))
pop
pop["Asymptomatic_disease", cycle = 1, ] <- n_cohort
pop["Progressive_disease", cycle = 1, ] <- 0
pop["Dead", cycle = 1, ] <- 0
head(pop)
# _arrived_ state populations
trans <- array(data = NA,
dim = c(n_states, n_cycles, n_treatments),
dimnames = list(state = s_names,
cycle = NULL,
treatment = t_names))
trans
trans[, cycle = 1, ] <- 0
trans
# Sum costs and QALYs for each cycle at a time for each drug
cycle_empty_array <-
array(NA,
dim = c(n_treatments, n_cycles),
dimnames = list(treatment = t_names,
cycle = NULL)) # per-cycle outcome template matrix
cycle_empty_array
cycle_state_costs <- cycle_trans_costs <- cycle_empty_array
cycle_state_costs
cycle_trans_costs
cycle_costs <- cycle_QALYs <- cycle_empty_array
LE <- LYs <- cycle_empty_array    # life expectancy; life-years
cycle_QALE <- cycle_empty_array   # quality-adjusted life expectancy
total_costs <- setNames(c(NA, NA), t_names)
total_costs
total_QALYs <- setNames(c(NA, NA), t_names)
tpDn_lookup <-
c("(34,44]" = 0.0017,
"(44,54]" = 0.0044,
"(54,64]" = 0.0138,
"(64,74]" = 0.0379,
"(74,84]" = 0.0912,
"(84,100]" = 0.1958)
age=48
cut(age, breaks = c(34,44,54,64,74,84,100))
tpDn <- tpDn_lookup[age_grp] # look up mortality table using age_grp label
age_grp <- cut(age, breaks = c(34,44,54,64,74,84,100)) # find the age group that this age falls into
tpDn <- tpDn_lookup[age_grp] # look up mortality table using age_grp label
tpDn
# Time-dependent probability matrix ----
p_matrix_cycle <- function(p_matrix, age, cycle,
tpProg = 0.01,
tpDcm = 0.15,
effect = 0.5) {
tpDn_lookup <-
c("(34,44]" = 0.0017,
"(44,54]" = 0.0044,
"(54,64]" = 0.0138,
"(64,74]" = 0.0379,
"(74,84]" = 0.0912,
"(84,100]" = 0.1958)
age_grp <- cut(age, breaks = c(34,44,54,64,74,84,100)) # find the age group that this age falls into
tpDn <- tpDn_lookup[age_grp] # look up mortality table using age_grp label
# Matrix containing transition probabilities for without_drug
p_matrix["Asymptomatic_disease", "Progressive_disease", "without_drug"] <- tpProg*cycle
p_matrix["Asymptomatic_disease", "Dead", "without_drug"] <- tpDn
p_matrix["Asymptomatic_disease", "Asymptomatic_disease", "without_drug"] <- 1 - tpProg*cycle - tpDn
p_matrix["Progressive_disease", "Dead", "without_drug"] <- tpDcm + tpDn
p_matrix["Progressive_disease", "Progressive_disease", "without_drug"] <- 1 - tpDcm - tpDn
p_matrix["Dead", "Dead", "without_drug"] <- 1
# Matrix containing transition probabilities for with_drug
p_matrix["Asymptomatic_disease", "Progressive_disease", "with_drug"] <- tpProg*(1 - effect)*cycle
p_matrix["Asymptomatic_disease", "Dead", "with_drug"] <- tpDn
p_matrix["Asymptomatic_disease", "Asymptomatic_disease", "with_drug"] <-
1 - tpProg*(1 - effect)*cycle - tpDn
p_matrix["Progressive_disease", "Dead", "with_drug"] <- tpDcm + tpDn
p_matrix["Progressive_disease", "Progressive_disease", "with_drug"] <- 1 - tpDcm - tpDn
p_matrix["Dead", "Dead", "with_drug"] <- 1
return(p_matrix)
}
## Run model ----
for (i in 1:n_treatments) { # outer loop: over strategies
age <- Initial_age
for (j in 2:n_cycles) { # inner loop: over cycles
# update cycle and age specific transition probability matrix
p_matrix <- p_matrix_cycle(p_matrix, age, j - 1)
#print(p_matrix[,,'with_drug']) # Uncomment this line to see how transition probability matrix changes over cycle
# calculate population health state distribution in the next cycle
pop[, cycle = j, treatment = i] <-
pop[, cycle = j - 1, treatment = i] %*% p_matrix[, , treatment = i]
# calculate the total transitional costs per cycle
trans[, cycle = j, treatment = i] <-
pop[, cycle = j - 1, treatment = i] %*% (trans_c_matrix * p_matrix[, , treatment = i])
age <- age + 1
}
# calculate cycle-specific state costs given a treatment strategy
cycle_state_costs[i, ] <-
(state_c_matrix[treatment = i, ] %*% pop[, , treatment = i]) * 1/(1 + cDr)^(1:n_cycles - 1)
# discounting at _previous_ cycle
cycle_trans_costs[i, ] <-
(c(1,1,1) %*% trans[, , treatment = i]) * 1/(1 + cDr)^(1:n_cycles - 2) # dot product with c(1,1,1) sums transitional cost across states and generate per-cycle total transitional cost
# per-cycle cost is the summ of state cost and transitional cost
cycle_costs[i, ] <- cycle_state_costs[i, ] + cycle_trans_costs[i, ]
# life expectancy
LE[i, ] <- c(1,1,0) %*% pop[, , treatment = i]
# life-years
LYs[i, ] <- LE[i, ] * 1/(1 + oDr)^(1:n_cycles - 1)
# quality-adjusted life expectancy
cycle_QALE[i, ] <-
state_q_matrix[treatment = i, ] %*% pop[, , treatment = i]
# quality-adjusted life-years
cycle_QALYs[i, ] <- cycle_QALE[i, ] * 1/(1 + oDr)^(1:n_cycles - 1)
# calculate the total cost and qaly (sum of per-cycle costs and qalys) of each scenario
total_costs[i] <- sum(cycle_costs[treatment = i, -1])
total_QALYs[i] <- sum(cycle_QALYs[treatment = i, -1])
}
cycle_costs
cycle_QALYs[i, ] <- cycle_QALE[i, ] * 1/(1 + oDr)^(1:n_cycles - 1)
cycle_QALYs
total_costs
# Incremental costs and QALYs of with_drug vs to without_drug
c_incr <- total_costs["with_drug"] - total_costs["without_drug"]
q_incr <- total_QALYs["with_drug"] - total_QALYs["without_drug"]
c_incr
q_incr
# Incremental cost-effectiveness ratio
ICER <- c_incr/q_incr
plot(x = q_incr/n_cohort, y = c_incr/n_cohort,
xlim = c(0, 2),
ylim = c(0, 15e3),
pch = 16, cex = 1.5,
xlab = "QALY difference",
ylab = paste0("Cost difference (", enc2utf8("\u00A3"), ")"),
frame.plot = FALSE)
plot(x = q_incr/n_cohort, y = c_incr/n_cohort,
xlim = c(0, 2),
ylim = c(0, 15e3),
pch = 16, cex = 1.5,
xlab = "QALY difference",
ylab = paste0("Cost difference (", enc2utf8("\u00A3"), ")"),
frame.plot = FALSE)
abline(a = 0, b = wtp)
wtp <- 20000
plot(x = q_incr/n_cohort, y = c_incr/n_cohort,
xlim = c(0, 2),
ylim = c(0, 15e3),
pch = 16, cex = 1.5,
xlab = "QALY difference",
ylab = paste0("Cost difference (", enc2utf8("\u00A3"), ")"),
frame.plot = FALSE)
abline(a = 0, b = wtp)
"A1000">"A10"
"A1020">"A1100"
setwd("/Users/kyueunlee/Library/CloudStorage/OneDrive-UW/My Drive/Z Drive/Project_all/2025_FluSeq")
dt <- read.xls("gisaid_epiflu_isolates.xls")
library(readxl)
dt <- read.xls("gisaid_epiflu_isolates.xls")
dt <- read_excel("gisaid_epiflu_isolates.xls")
head(dt)
mutate(state = str_extract(Isolate_Name, "(?<=^[A-Z]/)[^/]+")
)
library(tidyverse)
dt <- dt %>%
)
dt <- dt %>%
mutate(state = str_extract(Isolate_Name, "(?<=^[A-Z]/)[^/]+"))
dt$state
dt <- dt %>%
mutate(state = str_extract(Isolate_Name, "(?<=^[A-Z]/)[^/]+"),
date = as.Date(Collection_Date))
dt$date
year(dt$date[1])
month(dt$date[1])
dt <- dt %>%
mutate(state = str_extract(Isolate_Name, "(?<=^[A-Z]/)[^/]+"),
date = as.Date(Collection_Date),
month = month(date))
clade_summary <- dt %>%
group_by(state, month, Clade) %>%
summarise(
n = n()
)
clade_summary
clade_summary <- dt %>%
group_by(state, month, Clade) %>%
summarise(
n = n()
) %>%
group_by(state, month) %>%
mutate(freq = n / sum(n)) %>%
ungroup()
clade_summary
ggplot(clade_summary, aes(x=month, y=freq, fill=Clade))+
geom_col(position="fill")+
facet_wrap(~state, scales="free_y")
ggplot(clade_summary %>% filter(state=="Alabama"), aes(x=month, y=freq, fill=Clade))+
geom_col(position="fill")+
facet_wrap(~state, scales="free_y")
clade_summary <- dt %>%
group_by(state, Clade) %>%
summarise(
n = n()
) %>%
group_by(state) %>%
mutate(freq = n / sum(n)) %>%
ungroup()
ggplot(clade_summary , aes(x=state, y=freq, fill=Clade))+
geom_col(position="fill")+
facet_wrap(~state, scales="free_y")
ggplot(clade_summary , aes(x=state, y=freq, fill=Clade))+
geom_col(position="fill")
state.abb
state
state.name
state_dt <- data.frame(state = state.name, state_abb = state.abb)
dt <- dt %>%
mutate(state = str_extract(Isolate_Name, "(?<=^[A-Z]/)[^/]+"),
date = as.Date(Collection_Date),
month = month(date)) %>%
left_join(state_dt, by=state)
dt <- dt %>%
mutate(state = str_extract(Isolate_Name, "(?<=^[A-Z]/)[^/]+"),
date = as.Date(Collection_Date),
month = month(date)) %>%
left_join(state_dt, by="state")
dt_dt
dt
dt$state_abb
clade_summary <- dt %>%
group_by(state_abb, Clade) %>%
summarise(
n = n()
) %>%
group_by(state_abb) %>%
mutate(freq = n / sum(n)) %>%
ungroup()
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill")
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill") %>%
theme_bw()
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill") %>%
theme_bw()
clade_summary <- dt %>%
group_by(state_abb, Clade) %>%
summarise(
n = n()
) %>%
group_by(state_abb) %>%
mutate(freq = n / sum(n)) %>%
ungroup()
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill") %>%
theme_bw()
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill") +
theme_bw()
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill") +
theme_bw() +
ylim(0,1)
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill") +
theme_bw() +
scale_y_continuous(expand=c(0,0))
season=1009
season=2009
dt <- read_excel(paste0("gisaid_epiflu_isolates_",season,".xls"))
dt <- read_excel(paste0("data/gisaid_epiflu_isolates_",season,".xls"))
dt <- dt %>%
mutate(state = str_extract(Isolate_Name, "(?<=^[A-Z]/)[^/]+"),
date = as.Date(Collection_Date),
month = month(date)) %>%
left_join(state_dt, by="state")
clade_summary <- dt %>%
group_by(state_abb, Clade) %>%
summarise(
n = n()
) %>%
group_by(state_abb) %>%
mutate(freq = n / sum(n)) %>%
ungroup()
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill") +
theme_bw() +
scale_y_continuous(expand=c(0,0))+
ggtitle(paste0(season,"/", season+1))+
theme(plot.title = element_text(hjust = 0.5))
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill") +
theme_bw() +
scale_y_continuous(expand=c(0,0))+
ggtitle(paste0(season,"-", season+1))+
theme(plot.title = element_text(hjust = 0.5))
ggsave(paste0("graph/clade_distribution_",season,".pdf"))
ggsave(paste0("graph/clade_distribution_",season,".pdf"))
ggsave(paste0("graph/clade_distribution_",season,".pdf"),width=7,height=5)
for (season in seq(2009,2019)){
print(season)
# clade frequency data
dt <- read_excel(paste0("data/gisaid_epiflu_isolates_",season,".xls"))
dt <- dt %>%
mutate(state = str_extract(Isolate_Name, "(?<=^[A-Z]/)[^/]+"),
date = as.Date(Collection_Date),
month = month(date)) %>%
left_join(state_dt, by="state")
clade_summary <- dt %>%
group_by(state_abb, Clade) %>%
summarise(
n = n()
) %>%
group_by(state_abb) %>%
mutate(freq = n / sum(n)) %>%
ungroup()
ggplot(clade_summary , aes(x=state_abb, y=freq, fill=Clade))+
geom_col(position="fill") +
theme_bw() +
scale_y_continuous(expand=c(0,0))+
ggtitle(paste0(season,"-", season+1))+
theme(plot.title = element_text(hjust = 0.5))
ggsave(paste0("graph/clade_distribution_",season,".pdf"),width=7,height=5)
}
library(tidyverse)
setwd("/Users/kyueunlee/Library/CloudStorage/OneDrive-UW/My Drive/Z Drive/Project_all/2025_FluSeq/data")
# Nextstrain AA data
dt <- readxl::read_xlsx("h3n2_ha_12y_2025-10-01_metadata.xlsx")
# AA substitutions
dt <- dt %>%
mutate(
aa_sub1 = str_match(labels, "HA1:\\s*([^;'}]+)")[,2],
aa_sub2 = str_match(labels, "HA2:\\s*([^;'}]+)")[,2]
)
# A function to get the list of mutations
get_mutations_path <- function(dt, start_node, end_node) {
path_mutations <- c()
current_node <- start_node
vax_parent_node <- dt$parent_name[dt$name == end_node]
# accumulate AA substitutions until the vax parent node
while (current_node != vax_parent_node) {
row <- dt %>% filter(name == current_node)
if (nrow(row) == 0 || is.na(row$parent_name)) {
message("Reached a node with no parent or parent not found: ", current_node)
break
}
# extract mutations string
muts <- row$aa_sub1
path_mutations <- c(path_mutations, muts)
#if (!is.na(muts) && muts != "character(0)") {
#  path_mutations <- c(path_mutations, muts)
#}
current_node <- row$parent_name
}
# Add the AA substitutions from vax parent node to vax node
last <- dt %>% filter(name == end_node & parent_name == current_node)
muts <- last$aa_sub1
path_mutations <- c(path_mutations, muts)
flat_vector <- path_mutations %>%
str_split(",") %>%     # split each element by comma
unlist() %>%            # flatten into one vector
str_trim() %>%
discard(~ is.na(.x) | .x == "")
}
# List of vax and circulating viruses by season
dt_vax_clade <- readxl::read_xlsx("Clade_vax_AA_antgdistance.xlsx")
mutations_list <- get_mutations_path(dt, "NODE_0000003", "A/Perth/16/2009")
mutations_list
dt
# Save aa substitutions between vax and circulating viruses
dt_vax_clade2 <- dt_vax_clade %>%
mutate(clade = ifelse(clade == "3C.2a1b.2a.1","3C.2a1b.2a",clade))%>%
rowwise()%>%
mutate(
start_node =min(dt$name[dt$clade_membership==clade & substr(dt$name,1,4) == "NODE"]),
aa_list = list(get_mutations_path(dt, start_node, vaccine))
)
dt_vax_clade2
write.csv(dt_vax_clade2,"Clade_vax_AA_antgdistance_final.xlsx")
unlist(dt_vax_clade2)
unlist(dt_vax_clade2$aa_list)
unnest(dt_vax_clade2)
unnest(dt_vax_clade2$aa_list)
unnest(dt_vax_clade2)
dt_vax_clade2_long <- unnest(dt_vax_clade2)
write.csv(dt_vax_clade2_long,"Clade_vax_AA_antgdistance_long.xlsx")
write.csv(dt_vax_clade2_long,"Clade_vax_AA_antgdistance_long.xlsx")
write.csv(as.data.frame(dt_vax_clade2_long),"Clade_vax_AA_antgdistance_long.xlsx")
getwd
getwd()
write.csv(as.data.frame(dt_vax_clade2_long),"Clade_vax_AA_antgdistance_long.csv")
